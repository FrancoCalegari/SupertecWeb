<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Admin Dashboard - Productos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
* { box-sizing: border-box; }
body { font-family: Arial, sans-serif; margin: 0; background: #f4f6f8; }
header { background: #222; color: #fff; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }
h1 { margin: 0; font-size: 1.5rem; }
.container { max-width: 1100px; margin: 2rem auto; padding: 0 1rem; }

/* Tabla */
table { width: 100%; border-collapse: collapse; margin-top: 1rem; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #0001; }
th, td { padding: 0.75rem; border-bottom: 1px solid #eee; text-align: left; font-size: 0.95rem; }
th { background: #f0f0f0; font-weight: 600; }
img { max-width: 70px; border-radius: 4px; }
.actions button { margin-right: 0.3rem; margin-bottom: 0.3rem; }


/* Botones */
.add-btn { background: #28a745; color: #fff; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; }
.edit-btn { background: #ffc107; color: #222; border: none; padding: 0.3rem 0.7rem; border-radius: 4px; cursor: pointer; }
.delete-btn { background: #dc3545; color: #fff; border: none; padding: 0.3rem 0.7rem; border-radius: 4px; cursor: pointer; }
.logout-btn { background: #dc3545; color: #fff; text-decoration: none; padding: 0.4rem 0.8rem; border-radius: 4px; }
.logout-btn:hover { background: #c82333; }

/* Modal */
.modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
.modal-content { background: #fff; padding: 20px; border-radius: 8px; text-align: center; min-width: 280px; max-width: 400px; width: 90%; }
.modal-content form { display: flex; flex-direction: column; gap: 0.5rem; }
.modal-content input { padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; }
.modal-content button { margin-top: 1rem; padding: 0.5rem; border: none; border-radius: 4px; cursor: pointer; }
.modal-content .save-btn { background: #28a745; color: #fff; }
.modal-content .cancel-btn { background: #dc3545; color: #fff; }
.modal-actions { margin-top: 15px; display: flex; justify-content: space-around; flex-wrap: wrap; gap: 10px; }
.btn-yes { background: #e74c3c; color: white; border: none; padding: 8px 16px; cursor: pointer; border-radius: 5px; }
.btn-no { background: #7f8c8d; color: white; border: none; padding: 8px 16px; cursor: pointer; border-radius: 5px; }

/* ================== Responsive ================== */
@media (max-width: 977px) {
table, thead, tbody, th, td, tr {
    display: block;
  }

  thead { 
    display: none; /* ocultar encabezados en móvil */
  }

  tr {
    background: #fff;
    margin-bottom: 1rem;
    border-radius: 8px;
    box-shadow: 0 2px 6px #0001;
    padding: 1rem;
  }

  td {
    border: none;
    display: flex;
    justify-content: space-between;
    padding: 0.5rem 0;
  }

  td::before {
    content: attr(data-label);
    font-weight: bold;
    margin-right: 0.5rem;
    color: #555;
  }

  .actions {
    justify-content: flex-end;
    gap: 0.5rem;
  }

  .actions button {
    flex: 1;
    padding: 0.5rem;
    font-size: 0.85rem;
  }
}


</style>
</head>
<body>
<header>
    <h1>Admin Dashboard - Productos</h1>
    <a href="/logout" class="logout-btn">Cerrar sesión</a>
</header>
<!-- Modal de confirmación -->
<div id="confirmModal" class="modal">
  <div class="modal-content">
    <p id="confirmMessage">¿Seguro que deseas eliminar este producto?</p>
    <div class="modal-actions">
      <button id="confirmYes" class="btn-yes">Sí, eliminar</button>
      <button id="confirmNo" class="btn-no">Cancelar</button>
    </div>
  </div>
</div>

<div class="container">
    <button class="add-btn" onclick="showForm()">Agregar Producto</button>
    <table>
        <thead>
            <tr>
                <th>ID</th>
                <th>Imagen</th>
                <th>Nombre</th>
                <th>Descripción</th>
                <th>Precio</th>
                <th>Categoría</th>
                <th>Stock</th>
                <th>Marca</th>
                <th>Modelo</th>
                <th>Acciones</th>
            </tr>
        </thead>
        <tbody id="productsTable"></tbody>
    </table>
</div>

<!-- Modal -->
<div id="productModal" class="modal">
    <div class="modal-content">
        <h3 id="modalTitle">Agregar Producto</h3>
        <form id="productForm" onsubmit="saveProduct(event)">
            <input type="hidden" id="productId">
            <input type="text" id="name" placeholder="Nombre" required>
            <div>
                <label>Imagen (URL o Archivo)</label>
                <input type="text" id="img" placeholder="URL de imagen">
                <input type="file" id="imgFile" accept=".png,.jpg,.jpeg,.webp,.avif">
            </div>
            <input type="text" id="description" placeholder="Descripción" required>
            <input type="number" id="precio" placeholder="Precio" required>
            <input type="text" id="categoria" placeholder="Categoría" required>
            <input type="number" id="stock" placeholder="Stock" required>
            <input type="text" id="marca" placeholder="Marca" required>
            <input type="text" id="modelo" placeholder="Modelo" required>
            <button type="submit" class="save-btn">Guardar</button>
            <button type="button" class="cancel-btn" onclick="hideForm()">Cancelar</button>
        </form>
    </div>
</div>

<script>
let productos = [];

// Cargar productos desde JSON
async function loadProductos() {
    try {
        const res = await fetch('/api/productos');
        productos = await res.json();
        renderTable();
    } catch(err) {
        alert('Error al cargar productos');
    }
}

function renderTable() {
    const tbody = document.getElementById('productsTable');
    tbody.innerHTML = '';
    productos.forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td data-label="ID">${p.id}</td>
            <td data-label="Imagen"><img src="${p.img}" alt="${p.name}"></td>
            <td data-label="Nombre">${p.name}</td>
            <td>${p.description}</td>
            <td data-label="Precio">$${p.precio}</td>
            <td>${p.categoria}</td>
            <td>${p.stock}</td>
            <td>${p.marca}</td>
            <td>${p.modelo}</td>
            <td data-label="Acciones" class="actions">
                <button class="edit-btn" onclick="editProduct(${p.id})">Editar</button>
                <button class="delete-btn" onclick="console.log('Eliminar', ${p.id}); deleteProduct(${p.id})">Eliminar</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// Mostrar modal
function showForm(edit = false) {
    document.getElementById('productModal').style.display = 'block';
    document.getElementById('modalTitle').textContent = edit ? 'Editar Producto' : 'Agregar Producto';
    if (!edit) document.getElementById('productForm').reset();
}

// Ocultar modal
function hideForm() {
    document.getElementById('productModal').style.display = 'none';
}

// Guardar producto
async function saveProduct(event) {
    event.preventDefault();

    const formData = new FormData();
    formData.append("id", document.getElementById("productId").value || "");
    formData.append("name", document.getElementById("name").value);
    formData.append("description", document.getElementById("description").value);
    formData.append("precio", document.getElementById("precio").value);
    formData.append("categoria", document.getElementById("categoria").value);
    formData.append("stock", document.getElementById("stock").value);
    formData.append("marca", document.getElementById("marca").value);
    formData.append("modelo", document.getElementById("modelo").value);

    // Si el usuario cargó archivo, se manda el archivo
    const fileInput = document.getElementById("imgFile");
    if (fileInput.files.length > 0) {
        formData.append("imgFile", fileInput.files[0]);
    } else {
        formData.append("img", document.getElementById("img").value);
    }

    try {
        await fetch('/api/productos', {
            method: 'POST',
            body: formData
        });
        hideForm();
        loadProductos();
    } catch (err) {
        alert('Error al guardar producto');
    }
}


// Editar producto
function editProduct(id) {
    const p = productos.find(prod => prod.id === id);
    if (!p) return;
    showForm(true);
    document.getElementById('productId').value = p.id;
    document.getElementById('name').value = p.name;
    document.getElementById('img').value = p.img;
    document.getElementById('description').value = p.description;
    document.getElementById('precio').value = p.precio;
    document.getElementById('categoria').value = p.categoria;
    document.getElementById('stock').value = p.stock;
    document.getElementById('marca').value = p.marca;
    document.getElementById('modelo').value = p.modelo;
}

// Eliminar producto

async function deleteProduct(id) {
    if (!confirm('¿Seguro que deseas eliminar este producto?')) return;

    try {
        const res = await fetch(`/api/productos/${id}`, { method: 'DELETE' });

        if (!res.ok) {
            const errorData = await res.json();
            alert('Error: ' + (errorData.error || 'No se pudo eliminar el producto'));
            return;
        }

        // Si elimina bien, volvemos a cargar los productos
        await loadProductos();
    } catch (err) {
        console.error('Error en deleteProduct:', err);
        alert('Error al eliminar producto');
    }
}


// Cerrar modal al hacer clic fuera del contenido
window.onclick = function(event) {
    const modal = document.getElementById('productModal');
    if (event.target == modal) hideForm();
}


// Mostrar modal de confirmación
function showConfirmModal(message, onConfirm) {
    const modal = document.getElementById("confirmModal");
    const msgEl = document.getElementById("confirmMessage");
    const yesBtn = document.getElementById("confirmYes");
    const noBtn = document.getElementById("confirmNo");

    msgEl.textContent = message;
    modal.style.display = "flex";

    // Evitar múltiples listeners
    yesBtn.onclick = () => {
        modal.style.display = "none";
        onConfirm();
    };

    noBtn.onclick = () => {
        modal.style.display = "none";
    };
}

// Eliminar producto con modal
async function deleteProduct(id) {
    showConfirmModal("¿Seguro que deseas eliminar este producto?", async () => {
        try {
            const res = await fetch(`/api/productos/${id}`, { method: 'DELETE' });

            if (!res.ok) {
                const errorData = await res.json();
                showConfirmModal("Error: " + (errorData.error || "No se pudo eliminar"), () => {});
                return;
            }

            await loadProductos();
        } catch (err) {
            console.error("Error en deleteProduct:", err);
            showConfirmModal("Error al eliminar producto", () => {});
        }
    });
}


// Inicializar tabla
loadProductos();
</script>
</body>
</html>
